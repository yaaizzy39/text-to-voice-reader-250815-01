# Text to Voice Reader - Chrome拡張

ウェブサイトの選択したテキストをAIVIS音声で読み上げるChrome拡張機能です。

## 機能

### 🔊 音声読み上げ機能
- **テキスト選択読み上げ**: ウェブページ上のテキストを選択すると読み上げボタンが表示
- **AIVIS音声合成**: 高品質なAI音声（Anneli等）でテキストを読み上げ
- **長文対応**: 1000文字を超える長文は自動分割して順次再生
- **フォールバック機能**: AIVIS APIが利用できない場合はブラウザ標準音声で代替

### 📥 ダウンロード機能
- **音声ファイルダウンロード**: 生成した音声をMP3ファイルとしてダウンロード
- **結合音声ダウンロード**: 長文の場合は全ブロックを結合したファイルを生成

### ⚙️ 設定・カスタマイズ
- **拡張機能のON/OFF**: ワンクリックで機能の有効/無効を切り替え
- **音声モデル選択**: デフォルト（Anneli）音声や追加したカスタムモデル
- **再生速度調整**: 0.5倍〜2.0倍で調整可能
- **音量調整**: 0%〜100%で調整可能
- **音質設定**: 低品質（高速）、標準品質、高品質から選択
- **カスタムモデル追加**: 独自の音声モデルUUIDを追加可能

### 🔒 セキュリティ
- **APIキー暗号化**: APIキーはAES-GCM暗号化で安全に保存
- **設定同期**: Chrome アカウント間での設定同期対応

### 🖱️ 操作方法
- **マウス選択**: テキスト選択完了時に読み上げボタンを表示
- **右クリックメニュー**: コンテキストメニューからも読み上げ実行
- **キーボード選択**: 矢印キーでの選択にも対応

## インストール方法

1. **Chromeの開発者モードを有効化**
   - Chrome の設定 → 拡張機能 → 開発者モードをON

2. **拡張機能を読み込み**
   - 「パッケージ化されていない拡張機能を読み込む」をクリック
   - このフォルダを選択

3. **APIキーを設定**
   - 拡張機能アイコンをクリックして設定画面を開く
   - [AIVIS API Keys](https://hub.aivis-project.com/cloud-api/api-keys) からAPIキーを取得
   - 取得したAPIキーを入力

## 使い方

### 基本的な使い方

1. **拡張機能を有効化**: 設定画面上部のトグルスイッチをONに
2. **テキストを選択**: 読み上げたいテキストをマウスで選択
3. **読み上げボタンをクリック**: 選択範囲の近くに表示される「🔊 読み上げ」ボタンをクリック
4. **音声を聞く**: 高品質なAI音声でテキストが読み上げられます
5. **ダウンロード**: 必要に応じて「📥 DL」ボタンで音声ファイルをダウンロード

### 右クリックメニューから

1. テキストを選択
2. 右クリック → 「選択したテキストを読み上げ」を選択

### 設定のカスタマイズ

- **拡張機能の状態**: 上部のトグルスイッチで有効/無効を切り替え
- **音声テスト**: 「🎵 音声テスト」ボタンで設定を確認
- **API動作確認**: 「🔧 API動作確認」ボタンでAIVIS APIの状態をチェック
- **音声モデル**: Anneli（女性）音声や追加したカスタムモデルを選択
- **カスタムモデル追加**: モデル名とUUIDを入力して独自の音声を追加
- **音声設定**: 再生速度（0.5-2.0倍）、音量（0-100%）、音質を調整

### クイックアクセス

- **APIキー取得**: 「🔑 APIキーを取得」ボタンで直接取得サイトへ
- **AIVIS音声モデルサイト**: 「🌐 AIVIS音声モデルサイト」で新しいモデルを探索

## 対応サイト

- すべてのウェブサイト（`<all_urls>`対応）
- PDFファイル
- オンライン記事・ブログ
- 学習サイト・資料
- SPA（Single Page Application）サイト

## エラー処理とフォールバック

### 接続エラー対応
- **接続失敗**: 「ページを再読み込みしてください」等の具体的な解決策を表示
- **バックグラウンド応答なし**: 「拡張機能を再読み込みしてください」等のガイダンス

### API エラー対応
1. **AIVIS APIエラー**: ブラウザ標準のWeb Speech APIで代替
2. **ネットワークエラー**: 自動でフォールバック音声に切り替え
3. **APIキー無効（401）**: 具体的なエラーメッセージと設定画面への案内
4. **利用制限（429）**: 待機を促すメッセージ
5. **サーバーエラー（5xx）**: 一時的にブラウザ標準音声を使用

## ファイル構成

```
text-to-voice-reader-250815-01/
├── manifest.json           # Chrome拡張の設定ファイル（Manifest V3）
├── background.js           # バックグラウンドスクリプト（API通信・暗号化）
├── content.js              # コンテンツスクリプト（テキスト選択・UI・音声再生）
├── content.css             # コンテンツ用スタイル
├── popup.html              # 設定画面HTML
├── popup.css               # 設定画面スタイル（ダークモード対応）
├── popup.js                # 設定画面ロジック（暗号化・同期）
├── audio-player.html       # 音声再生ウィジェット
├── CLAUDE.md               # 開発ガイドライン
└── README.md               # このファイル
```

## トラブルシューティング

### 音声が再生されない
- 拡張機能が有効になっているか確認（設定画面上部のトグル）
- APIキーが正しく設定されているか確認
- 「🎵 音声テスト」ボタンで動作確認
- ブラウザで音声再生が許可されているか確認
- ネットワーク接続を確認

### 「APIキーが無効」エラー
- [AIVIS API Keys](https://hub.aivis-project.com/cloud-api/api-keys) で新しいキーを生成
- コピー時に余分なスペースが入っていないか確認
- APIキーの有効期限を確認

### 接続エラーが発生する
- **「接続に失敗しました」**: ページを再読み込み（Ctrl+F5）
- **「バックグラウンドスクリプトが応答しません」**: 拡張機能を再読み込み
- Chrome の拡張機能ページで拡張機能の状態を確認

### 読み上げボタンが表示されない
- 拡張機能が有効になっているか確認
- テキスト選択を完了してからマウスを離す
- ページを再読み込みしてから再試行

### APIキーが表示されない
- 設定画面を一度閉じてから再度開く
- 暗号化設定の読み込み時間の問題の可能性

## 技術仕様

### Chrome拡張機能
- **Chrome拡張 Manifest V3** 対応
- **Service Worker** によるバックグラウンド処理
- **Content Scripts** による動的UI生成
- **Chrome Storage Sync API** での設定同期

### 音声技術
- **AIVIS Cloud API** を使用した高品質音声合成
- **Web Audio API** による直接音声再生（CSP制限回避）
- **Web Speech API** フォールバック対応
- **MP3/WAV音声結合** 技術

### セキュリティ
- **AES-GCM暗号化** によるAPIキー保護
- **PBKDF2** キー導出によるセキュリティ強化
- **CSP（Content Security Policy）** 準拠

### UI/UX
- **レスポンシブデザイン** 対応
- **ダークモード** 自動対応
- **アニメーション効果** による視覚的フィードバック
- **マルチライン選択** 対応の位置調整

## 開発者向け情報

### 参照元コード
このChrome拡張は `example-talk-avatar-250725-02` フォルダのチャットアプリから以下の機能を移植・改良:

- AIVIS API通信ロジック（`script.js:762-794`）
- ストリーミング音声再生（`script.js:818-932`） 
- エラーハンドリングとフォールバック（`script.js:754-760`）
- 音声設定管理（`script.js:796-816`）

### 主な改良点
- **Chrome拡張アーキテクチャ**に最適化（Manifest V3準拠）
- **APIキー暗号化保存**によるセキュリティ向上
- **拡張機能ON/OFF切り替え**機能
- **長文分割再生**と**音声ダウンロード**機能
- **Content Script でのテキスト選択UI**
- **Background Script でのAPI通信分離**
- **包括的なエラーハンドリング**と**接続問題の自動解決ガイダンス**
- **ユーザーフレンドリーな設定画面**（ボタン配置最適化）
- **カスタム音声モデル追加**機能
- **SPA対応**の堅牢な初期化システム

### アーキテクチャ
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Content.js    │───▶│   Background.js  │───▶│   AIVIS API     │
│ (UI + 選択検出)  │    │ (API通信+暗号化)  │    │ (音声合成)      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌──────────────────┐
│   Popup.js      │    │ Chrome Storage   │
│ (設定画面)      │    │ (暗号化設定)      │
└─────────────────┘    └──────────────────┘
```

## ライセンス

このソフトウェアは防御的セキュリティ目的でのみ使用を許可します。

## バージョン履歴

- **v1.0.0** (2024-08-15): 初回リリース
  - テキスト選択読み上げ機能
  - AIVIS API統合
  - フォールバック機能
  - 設定画面

- **v1.1.0** (2024-08-16): 機能拡張
  - 拡張機能ON/OFF切り替えスイッチ追加
  - APIキー暗号化保存実装
  - デフォルト音声をAnneli（女性）に変更
  - UI配置最適化（使い方ボタンを下部に移動）
  - API取得・動作確認ボタンを横並び配置

- **v1.2.0** (2024-08-17): 安定性向上
  - 接続エラー「Could not establish connection」修正
  - バックグラウンドスクリプト初期化順序改善
  - エラーハンドリング強化とユーザーガイダンス追加
  - デバッグログクリーンアップ
  - 音声ダウンロード機能追加
  - 長文分割再生機能追加