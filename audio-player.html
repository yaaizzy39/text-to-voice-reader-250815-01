<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
        }
        
        .audio-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 999999;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .audio-icon {
            font-size: 18px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .audio-text {
            font-weight: 500;
        }
        
        .audio-stop {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .audio-stop:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="audioContainer" class="audio-container">
        <span class="audio-icon">🔊</span>
        <span class="audio-text">音声を再生中...</span>
        <button id="stopBtn" class="audio-stop">停止</button>
    </div>

    <script>
        class AudioPlayerWidget {
            constructor() {
                this.currentAudio = null;
                this.isVisible = false;
                this.init();
            }

            init() {
                this.container = document.getElementById('audioContainer');
                this.stopBtn = document.getElementById('stopBtn');
                
                this.stopBtn.addEventListener('click', () => {
                    this.stopAudio();
                });

                // メッセージリスナー
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'PLAY_AUDIO') {
                        this.playAudio(event.data.audioUrl, event.data.settings);
                    } else if (event.data.type === 'STOP_AUDIO') {
                        this.stopAudio();
                    }
                });
            }

            async playAudio(audioUrl, settings = {}) {
                try {
                    // 既存の音声を停止
                    this.stopAudio();

                    // 新しい音声を作成
                    this.currentAudio = new Audio(audioUrl);
                    this.currentAudio.volume = settings.volume || 1.0;
                    this.currentAudio.playbackRate = settings.speed || 1.0;

                    // イベントリスナー
                    this.currentAudio.addEventListener('play', () => {
                        this.showWidget();
                    });

                    this.currentAudio.addEventListener('ended', () => {
                        this.hideWidget();
                        this.cleanup();
                    });

                    this.currentAudio.addEventListener('error', (e) => {
                        console.error('音声再生エラー:', e);
                        this.hideWidget();
                        this.cleanup();
                        // エラーを親ウィンドウに通知
                        window.parent.postMessage({
                            type: 'AUDIO_ERROR',
                            error: '音声の再生に失敗しました'
                        }, '*');
                    });

                    // 音声再生開始
                    await this.currentAudio.play();

                } catch (error) {
                    console.error('音声再生処理エラー:', error);
                    this.hideWidget();
                    // エラーを親ウィンドウに通知
                    window.parent.postMessage({
                        type: 'AUDIO_ERROR',
                        error: error.message
                    }, '*');
                }
            }

            stopAudio() {
                if (this.currentAudio && !this.currentAudio.paused) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }
                this.hideWidget();
                this.cleanup();
            }

            showWidget() {
                this.container.style.display = 'flex';
                this.isVisible = true;
            }

            hideWidget() {
                this.container.style.display = 'none';
                this.isVisible = false;
            }

            cleanup() {
                if (this.currentAudio) {
                    // オブジェクトURLをクリーンアップ
                    const audioUrl = this.currentAudio.src;
                    if (audioUrl.startsWith('blob:')) {
                        URL.revokeObjectURL(audioUrl);
                    }
                    this.currentAudio = null;
                }
            }
        }

        // 初期化
        new AudioPlayerWidget();
    </script>
</body>
</html>